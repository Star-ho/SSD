안녕하세요! MSA 트랙잭션 관리에서 궁금한 점이 생겨서 여쭤봅니다!

MSA 환경에서 정산에 관련된 API에 들어가야할 Task는 아래와 같습니다.

1. 결제 서비스에서 정상 결제 내역들을 확인하기
2. 각 결제 내역에 대한 계좌 정보를 가져온다
3. 정상 결재 내역 건들의 가맹점 별 금액 계산하기
4. 가맹점과 연결된 계좌에 정산된 금액을 이체하기
5. 결제 건들의 상태를(결제 완료 -> 정산 완료) 변경하기

모든 상황에서 에러가 발생할 수 있다는 가정입니다.

가정을 3개를 두었습니다.
Saga 도입
DLQ 도입
Task 순서 변경

이 상황에서 Saga를 도입하게 된다면,
1번 작업은 단순 조회 작업이라 상태를 변경시키지 않기에, 롤백이 필요없다고 생각하였습니다. -> Saga가 필요 없다고 생각하였습니다.

2, 3, 5번은 Payment에 기반한 Saga가 필요하다고 생각합니다. -> 각 Payment에 대한 독립적인 Saga 인스턴스를 생성하여 트랜잭션을 관리한다고 생각하였습니다.

문제는 여기입니다. 
4번은 Payment에 의존하는 것이 아니라 특정 franchiseIdToBankAccountMap에 의존하고 있습니다.
위 같은 상황일 땐 실무에서는 기존에 사용하던 Payment가 아닌 새로운 Saga를 만들어서 처리를 해야하는지 궁금합니다.
즉, 하나의 비즈니스 프로세스에서 2개 이상의 Saga를 사용하는게 좋은가요? 아니면 다른 방법을 사용해서 처리를 해야하는 건가요?


이 상황에서 DLQ(Dead Letter Queue)를 도입하게 된다면,
5번에서 호출을 Kafka에 Topic을 이용하고 Publisher나 Consumer에서 메세지가 실패했을 경우(5번에 대한 실패)에 DLQ에 전송을 한다.
DLQ에 전송된 메세지는 보상 트랙잭션을 발생한다거나 재시도 매커니즘을 도입하는 것도 좋아보입니다.
실무에서도 이러한 방법을 사용하고 있을까요?


이 상황에서 Task에 대한 순서 바꾸기
사실 이 부분을 제일 많이 고민 했던 부분입니다.
모든 부분에서 에러가 발생할수 있기에 트랙잭션을 처리해 주어야하는데 저는 트랙잭션이 어려운 부분이 있다면, 저만의 트랙잭션 우선순위 두기라는 것을 생각해보았습니다.

트랜잭션 우선순위란 다시 롤백하기 어려운 순서대로 우선순위가 높습니다. 해당 Task에서는 4번(펌뱅킹 요청, 이미 결제가 진행 됐다면 다시 돌리기가 어려움)이 가장 트랙잭션이 높다고 할 수 있습니다.
따라서 트랙잭션 우선순위가 높은걸 Task 순서상 가장 마지막에 두는 것이 좋다고 생각하였습니다.
왜냐하면 사실 순서상 4번 수행후 5번을 수행하는 것과 5번을 수행후 4번을 수행하는 것은 클라이언트 입장에서는 동일하다고 생각하였습니다.

그래서 Task 순서가 1->2->3->4->5가 아닌 1->2->3->5->4 순서로 가는 것도 어떤가요?

위 3개중에 어떤걸 가장 추천하시나요? 혹시 추천하신다면 그 이유도 들어볼 수 있을까요? 긴 글 읽어주셔서 너무 감사합니다!! 🙇🏻🙇🏻🙇🏻