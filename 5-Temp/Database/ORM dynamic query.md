---
date: 2023-11-17T22:32:04
---
안녕하세요 현재 ORM 쪽 다이나믹 쿼리 관련하여 문의드릴려고 하는데요 :) 
현재 대용량 테이블 (5T) 에  ORM 리드 쿼리가 사용자 통해서 동시다발적으로 인입이 되고 있는데요 조건절에 사용되는 컬럼이 in (varchar 128) 조건으로 대략 20개의 조건이 다이나믹하게 생성되어 실행되는 구조입니다

문제는 이 쿼리가 디비쪽 세션에서는 그리 오래걸리지 않고 정상수행되지만,
어플리케이션 쪽에서 수행 시 간헐적 슬로우쿼리 발생 및 실행계획이 잘못 생성되는걸 확인을 했는데요..
대용량 테이블이라 통계정보는 갱신이 되지 않는걸로 확인을 했습니다

혹시 ORM 쪽 다이나믹 쿼리 관련하여 
문제가 발생하여 해결하셨던 점이나, 알고계신 사항 있으시면 말씀해주시면 감사하겠습니다☺️

---

조건절에 사용되는 컬럼이 in (varchar 128) 조건으로 대략 20개의 조건이 다이나믹하게 생성되어 실행되는 구조입니다
=>
col1 in () [and|or] col2 in () 처럼 20개 내외의 컬럼이 조건으로 들어간다는건지
특정 컬럼인데 IN (20개 가량의 value) 인건지

---
column IN ('a01...128 chars...', 'a02...', 'a03...', 'a20...') 이 조건이라면 크게 문제되진 않을 것 같아 보이는데요. server side에서 오래 걸리지 않는다는 걸로 보아, 인덱스나 테이블 구조 이슈는 아닐듯 하고요. 

혹시 레코드 한건 한건의 크기(bytes)가 매우(?) 큰가요 ?

---

특정 컬럼인데 20개가량의 value 가 들어가는 형태이며  레코드 한건 한건 크기가 매우 큰 형태입니다

인덱스 페이지가 2.5T 정도며 데이터페이지가 2.7정도 차지하고 있습니다

---

혹시 실제 가져가는 레코드 한건 한건의 크기가 매우 커서 network 전송 시간이 영향을 미치는 것은 아닐까요 ?
아니면, 결과 건수가 매우 많아서 전송 시간이 많이 걸리는데, client side에서는 전체 데이터를 network 전송 시간까지 측정하다 보니 그런건 아닐지... 

---

in 파라미터 수가 다이나믹이라서 문제라면 하이버네이트에서는 in clause parameter padding 이라고 파라미터수를 2의 제곱승으로 맞춰주는 옵션이 있습니다

---

in절에 파라미터 수가 달라지면 prepared statement 로 날려도 새 쿼리로 인식하는데 해당 파라미터 수가 캐싱이 되었냐 안되었냐의 차이일 수 도 있습니다..

---

혹시 애플리케이션에서 걸린 시간이 오래 걸렸다고 나오는 거면 pool 관련 문제인지도 확인해보시면 좋을 거 같아요~ 응용프로그램 APM에서는 보통 ORM에서 connection pool 획득 대기시간 + 쿼리 결과를 언어 객체로 바꾸는 과정까지 합쳐서 DB 쿼리 시간으로 잡히더라고요

---
https://dba.stackexchange.com/questions/294722/large-30-mil-row-table-needing-to-use-where-in-clause 이것과 비슷한 유형인지 모르겠네요

mysql 의 내부구조를 몰라서 동일한 방식일지 모르겠지만 in 절에 있는 조건은 옵티마이저가  predicate 정규화를 거치면서 많은 메모리를 소모하는 경우가 있습니다.  조건개수가 많으면 db 옵티마이저가 그냥 full-scan 으로 처리해 버리는 경우를 타 db에서 본 경우가 있어서 mysql도 같은 유형의 문제일지도 모르겠습니다. 추측입니다.
